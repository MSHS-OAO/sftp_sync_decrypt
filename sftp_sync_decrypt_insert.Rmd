---
title: "SFTP_Sync_Decrypt_Insert"
output: html_document
date: "`r Sys.time()`"
---

```{css, echo = FALSE}
caption {
      color: red;
      font-weight: bold
      font-size: 13;
    }
```

```{r libraries, include=F}
library(dplyr)
library(glue)
library(readxl)
library(writexl)
library(kableExtra)
library(odbc)
library(DBI)
```

# SFTP Synchronization
```{r sftp_sync, echo=FALSE}
# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# get current MSHQ and BISLR file and date mapping file
mshq_dates <- read_excel(paste0(universal_dir, "Mapping/MSHQ_File_Dates.xlsx"))
bislr_dates <- read_excel(paste0(universal_dir, "Mapping/BISLR_File_Dates.xlsx"))

# get files currently in network directory
mshq_raw_files <- list.files(paste0(universal_dir, "/Labor/Raw Data/MSHQ_sftp_sync/Raw/"))
bislr_raw_files <- list.files(paste0(universal_dir, "/Labor//Raw Data/BISLR_sftp_sync/Raw/"))

# run lftp file to sync sftp to network drive
system('lftp -f /data/SFTP/sync_to_network.lftp')

# get new files in network drive
mshq_raw_files_new <- list.files(paste0(universal_dir, "/Labor/Raw Data/MSHQ_sftp_sync/Raw/"))
bislr_raw_files_new <- list.files(paste0(universal_dir, "/Labor/Raw Data/BISLR_sftp_sync/Raw/"))

#print new files that were copied over in sync
new_files <- setdiff(c(mshq_raw_files_new, bislr_raw_files_new),
                     c(mshq_raw_files, bislr_raw_files))
if (length(new_files) > 0) {
  cat(cat(paste0(new_files, "\n")), "have been added to the network drive", fill = TRUE)
} else {
  print("Network drive is already up to date")
}

# add any new files to the mshq dates files
mshq_raw_files_info <- file.info(list.files(paste0(universal_dir, "/Labor/Raw Data/MSHQ_sftp_sync/Raw/"), 
                                       full.names = T))
mshq_raw_files_info <- data.frame(RAW = basename(rownames(mshq_raw_files_info)),
                                  RAW_MTIME = mshq_raw_files_info$mtime)
mshq_dates <- mshq_raw_files_info %>%
  left_join(mshq_dates, by = join_by(RAW, RAW_MTIME)) %>%
  select(RAW, DECRYPT, INSERT, RAW_MTIME, START_DATE, END_DATE) %>%
  arrange(RAW_MTIME)
write_xlsx(mshq_dates, paste0(universal_dir, "Mapping/MSHQ_File_Dates.xlsx"))

# add any new files to the bislr dates files
bislr_raw_files_info <- file.info(list.files(paste0(universal_dir, "/Labor/Raw Data/BISLR_sftp_sync/Raw/"), 
                                       full.names = T))
bislr_raw_files_info <- data.frame(RAW = basename(rownames(bislr_raw_files_info)),
                                  RAW_MTIME = bislr_raw_files_info$mtime)
bislr_dates <- bislr_raw_files_info %>%
  left_join(bislr_dates, by = join_by(RAW, RAW_MTIME)) %>%
  select(RAW, DECRYPT, INSERT, RAW_MTIME, START_DATE, END_DATE) %>%
  arrange(RAW_MTIME)
write_xlsx(bislr_dates, paste0(universal_dir, "Mapping/BISLR_File_Dates.xlsx"))

print("sftp_sync successful")
```

# Decryption
#### Import Decryption Key
```{r import_key, echo=FALSE}
system('cat /data/SFTP/MSH_ALLINTERNAL_OB_PRIVATE.asc | gpg --import --no-tty --batch --yes')
print("import_key successful")
```

#### MSHQ Decryption
```{r mshq_decrypt, echo=FALSE}
# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# get current MSHQ and file and date mapping file
mshq_dates <- read_excel(paste0(universal_dir, "Mapping/MSHQ_File_Dates.xlsx"))

# list files in the raw and decryption directories
decrypt_files <- list.files(paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Decrypt/"))

# list files that need to be decrypted
files_to_decrypt <- mshq_dates %>%
  filter(!(gsub(".out", "", RAW) %in% decrypt_files)) %>%
  select(RAW) %>%
  pull()
  
# decrypt each file in raw folder and not in the decrypted folder
decrypt_function <- lapply(files_to_decrypt, function(x) {
  encrypted <- paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Raw/", x)
  decrypted <- paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Decrypt/", gsub(".out", "", x))
  system(glue("gpg --output '{decrypted}' --decrypt --pinentry-mode loopback --passphrase-file /data/SFTP/password.txt --batch '{encrypted}'"))
  }
)

# get new files in network drive
decrypt_files_new <- list.files(paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Decrypt/"))

# print new files that were decrypted
new_files <- setdiff(decrypt_files_new, decrypt_files)
if (length(new_files) > 0) {
  print(paste(new_files, "has been decrypted"))
} else {
  print("No new MSHQ files to decrypt")
}

# add any new files to the mshq dates files
mshq_dates <- mshq_dates %>%
  mutate(DECRYPT = case_when(
    is.na(DECRYPT) ~ gsub(".out", "", RAW),
    TRUE ~ DECRYPT))
write_xlsx(mshq_dates, paste0(universal_dir, "Mapping/MSHQ_File_Dates.xlsx"))

print("mshq_decrypt successful")
```

#### BISLR Decryption
```{r bislr_decrypt, echo=FALSE}
# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# get current MSHQ and BISLR file and date mapping file
bislr_dates <- read_excel(paste0(universal_dir, "Mapping/BISLR_File_Dates.xlsx"))

# list files in the raw and decryption directories
decrypt_files <- list.files(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Decrypt/"))

# list files that need to be decrypted
files_to_decrypt <- bislr_dates %>%
  filter(!(gsub(".out", "", RAW) %in% decrypt_files)) %>%
  select(RAW) %>%
  pull()
  
# decrypt each file in raw folder and not in the decrypted folder
decrypt_function <- lapply(files_to_decrypt, function(x) {
  encrypted <- paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Raw/", x)
  decrypted <- paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Decrypt/", gsub(".out", "", x))
  system(glue("gpg --output '{decrypted}' --decrypt --pinentry-mode loopback --passphrase-file /data/SFTP/password.txt --batch '{encrypted}'"))
  }
)

# get new files in network drive
decrypt_files_new <- list.files(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Decrypt/"))

# print new files that were decrypted
new_files <- setdiff(decrypt_files_new, decrypt_files)
if (length(new_files) > 0) {
  print(paste(new_files, "has been decrypted"))
} else {
  print("No new BISLR files to decrypt")
}

# add any new files to the mshq dates files
bislr_dates <- bislr_dates %>%
  mutate(DECRYPT = case_when(
    is.na(DECRYPT) ~ gsub(".out", "", RAW),
    TRUE ~ DECRYPT))
write_xlsx(bislr_dates, paste0(universal_dir, "Mapping/BISLR_File_Dates.xlsx"))

print("bislr_decrypt successful")
```

# Insert Creation
#### MSHQ Inserts
```{r mshq_insert, echo=FALSE}
# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# col names for Oracle DB
db_columns <- c("PARTNER", "HOME_FACILITY", "HOME_DEPARTMENT", "WORKED_FACILITY", 
                "WORKED_DEPARTMENT", "START_DATE", "END_DATE", "EMPLOYEE_ID",
                "EMPLOYEE_NAME", "APPROVED_HOURS", "POSITION_CODE", "JOBCODE",
                "PAYCODE", "WD_HOURS", "WD_EXPENSE", "HOME_DEPARTMENT_NAME",
                "WORKED_DEPARTMENT_NAME", "POSITION_CODE_DESCRIPTION",
                "LOCATION_DESCRIPTION", "WD_COFT", "WD_ACCOUNT", "WD_LOCATION",
                "WD_DEPARTMENT", "WD_FUND_NUMBER", "HD_COFT", "HD_LOCATION",
                "HD_DEPARTMENT", "WD_COA", "HD_COA", "PAYROLL_NAME",
                "REVERSE_MAP_WORKED", "REVERSE_MAP_HOME", "FILE_NAME")

# read in mshq dates file 
mshq_dates <- read_excel(paste0(universal_dir, "Mapping/MSHQ_File_Dates.xlsx")) %>%
  mutate(INSERT = case_when(
    START_DATE == "IGNORE" ~ "IGNORE",
    is.na(START_DATE) ~ NA,
    TRUE ~ INSERT))
# get list of files that need dates/Ignore
mshq_dates_new <- mshq_dates %>%
  filter(is.na(START_DATE))

# get list of files in insert folder currently
insert_files <- list.files(paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Insert/")) 

# update mshq dates for files with newly added START_DATE and END_DATE values
mshq_dates <- mshq_dates %>% 
  arrange(START_DATE) %>% 
  mutate(INSERT = case_when(
    is.na(INSERT) & !is.na(START_DATE) & START_DATE != "IGNORE" ~ paste0(row.names(.), "_", DECRYPT),
    TRUE ~ INSERT)) %>%
  arrange(RAW_MTIME)

# get list of files that now have date values but dont have an insert file
new_inserts <- setdiff(mshq_dates %>% 
                         filter(!is.na(INSERT) & START_DATE != "IGNORE") %>% 
                         select(INSERT) %>% 
                         pull(),
                       insert_files)
# list of files that need an insert file created
create_inserts <- mshq_dates %>%
  filter(INSERT %in% new_inserts) %>%
  select(DECRYPT) %>%
  pull()

# create a new insert file for all decrypted files that need insert files
inserts <- lapply(create_inserts, function(x) {
  data <-  read.csv(paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Decrypt/", x),
                    sep = "~", header = T, stringsAsFactors = F,
                    colClasses = rep("character", 32), strip.white = TRUE) %>%
    mutate(FILENAME = mshq_dates %>%
             filter(DECRYPT == x) %>%
             select(INSERT) %>%
             pull()) %>%
    mutate(Start.Date = format(as.Date(Start.Date, format = "%m/%d/%Y"), "%Y-%m-%d"),
           End.Date = format(as.Date(End.Date, format = "%m/%d/%Y"), "%Y-%m-%d"),
           Job.Code = case_when(
             Job.Code == "" ~ "UNKNOWN",
             TRUE ~ Job.Code)) %>%
    filter(Start.Date >= as.Date(pull(filter(mshq_dates, DECRYPT == x) %>%
                                         select(START_DATE)), format = "%Y-%m-%d"),
           End.Date <= as.Date(pull(filter(mshq_dates, DECRYPT == x) %>%
                                      select(END_DATE)), format = "%Y-%m-%d"))
})
# apply column names of oracle db to all new insert files
inserts <- lapply(inserts, setNames, db_columns)
names(inserts) <- create_inserts

insert_function <- lapply(names(inserts), function(x) {
  write.table(inserts[[x]], paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Insert/",
                                   mshq_dates %>% 
                                     filter(DECRYPT == x) %>%
                                     select(INSERT) %>%
                                     pull()),
              sep = "~", row.names = FALSE)
})

# save updated mshq dates file
write_xlsx(mshq_dates, paste0(universal_dir, "Mapping/MSHQ_File_Dates.xlsx"))

# list new insert files if there are any
if (length(new_inserts) > 0) {
  cat(cat(paste0(new_inserts, "\n")), "has been added to the Insert folder", fill = TRUE)
} else {
  print("Insert files are already up to date")
}

# list files that need START_DATE and END_DATE values
if (nrow(mshq_dates_new) > 0) {
  kable(mshq_dates_new, 
        caption = "The following files need START_DATE and END_DATE values in MSHQ_File_Dates.xlsx:") %>% 
    kable_styling(latex_options = "striped", 
                  font_size = 10) %>%
    row_spec(0, font_size = 13)
} else {
  print("MSHQ_File_Dates.xlsx is up to date")
}

print("mshq_insert successful")
```

#### BISLR Inserts
```{r bislr_insert, echo=FALSE}
# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# col names for Oracle DB
db_columns <- c("PARTNER", "HOME_FACILITY", "HOME_DEPARTMENT", "WORKED_FACILITY", 
                "WORKED_DEPARTMENT", "START_DATE", "END_DATE", "EMPLOYEE_ID",
                "EMPLOYEE_NAME", "APPROVED_HOURS", "POSITION_CODE", "JOBCODE",
                "PAYCODE", "WD_HOURS", "WD_EXPENSE", "HOME_DEPARTMENT_NAME",
                "WORKED_DEPARTMENT_NAME", "POSITION_CODE_DESCRIPTION",
                "LOCATION_DESCRIPTION", "WD_COFT", "WD_ACCOUNT", "WD_LOCATION",
                "WD_DEPARTMENT", "WD_FUND_NUMBER", "HD_COFT", "HD_LOCATION",
                "HD_DEPARTMENT", "WD_COA", "HD_COA", "PAYROLL_NAME",
                "REVERSE_MAP_WORKED", "REVERSE_MAP_HOME", "FILE_NAME")

#Names of the weekly paycyle names in the payroll name column in data files
weekly_pc <- c("WEST WEEKLY", "BIB WEEKLY")

# read in bislr dates file 
bislr_dates <- read_excel(paste0(universal_dir, "Mapping/BISLR_File_Dates.xlsx")) %>%
  mutate(INSERT = case_when(
    START_DATE == "IGNORE" ~ "IGNORE",
    is.na(START_DATE) ~ NA,
    TRUE ~ INSERT))

# get list of files that need dates/Ignore
bislr_dates_new <- bislr_dates %>%
  filter(is.na(START_DATE))

# get list of files in insert folder currently
insert_files <- list.files(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Insert/")) 

# update mshq dates for files with newly added START_DATE and END_DATE values
bislr_dates <- bislr_dates %>% 
  arrange(START_DATE) %>% 
  mutate(INSERT = case_when(
    is.na(INSERT) & !is.na(START_DATE) & START_DATE != "IGNORE" ~ paste0(row.names(.), "_", DECRYPT),
    TRUE ~ INSERT)) %>%
  arrange(RAW_MTIME)

# get list of files that now have date values but dont have an insert file
new_inserts <- setdiff(bislr_dates %>% 
                         filter(!is.na(INSERT) & START_DATE != "IGNORE") %>% 
                         select(INSERT) %>% 
                         pull(),
                       insert_files)
# list of files that need an insert file created
create_inserts <- bislr_dates %>%
  filter(INSERT %in% new_inserts) %>%
  select(DECRYPT) %>%
  pull()

# create list of start and end dates for all insert files
delete_weekly <- lapply(create_inserts, function(x) {
  data <- read.csv(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Decrypt/", x),
                    sep = "~", header = T, stringsAsFactors = F,
                    colClasses = rep("character", 32), strip.white = TRUE) %>%
     mutate(Start.Date = format(as.Date(Start.Date, format = "%m/%d/%Y"), "%Y-%m-%d"),
           End.Date = format(as.Date(End.Date, format = "%m/%d/%Y"), "%Y-%m-%d")) %>%
    filter(Start.Date >= as.Date(pull(filter(bislr_dates, DECRYPT == x) %>%
                                         select(START_DATE)), format = "%Y-%m-%d"),
           End.Date <= as.Date(pull(filter(bislr_dates, DECRYPT == x) %>%
                                      select(END_DATE)), format = "%Y-%m-%d")) %>%
    arrange(Start.Date, End.Date) %>%
    mutate(Start_End = paste0(Start.Date, "_", End.Date)) %>%
    select(Start.Date, End.Date, Start_End) %>%
    distinct() %>%
    filter(Start.Date == max(Start.Date))
})
# assign create_inserts as the name for the delete weekly list elements
names(delete_weekly) <- create_inserts

# create a new insert file for all decrypted files that need insert files
inserts <- lapply(create_inserts, function(x) {
  data <-  read.csv(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Decrypt/", x),
                    sep = "~", header = T, stringsAsFactors = F,
                    colClasses = rep("character", 32), strip.white = TRUE) %>%
    mutate(FILENAME = bislr_dates %>%
             filter(DECRYPT == x) %>%
             select(INSERT) %>%
             pull()) %>%
    mutate(Start.Date = format(as.Date(Start.Date, format = "%m/%d/%Y"), "%Y-%m-%d"),
           End.Date = format(as.Date(End.Date, format = "%m/%d/%Y"), "%Y-%m-%d"),
           Job.Code = case_when(
             Job.Code == "" ~ "UNKNOWN",
             TRUE ~ Job.Code)) %>%
    filter(Start.Date >= as.Date(pull(filter(bislr_dates, DECRYPT == x) %>%
                                         select(START_DATE)), format = "%Y-%m-%d"),
           End.Date <= as.Date(pull(filter(bislr_dates, DECRYPT == x) %>%
                                      select(END_DATE)), format = "%Y-%m-%d")) %>%
    mutate(Start_End = paste0(Start.Date, "_", End.Date)) %>%
    filter(Start_End != delete_weekly[[x]][,"Start_End"]) %>%
    select(-Start_End)
})
# apply column names of oracle db to all new insert files
inserts <- lapply(inserts, setNames, db_columns)
names(inserts) <- create_inserts

insert_function <- lapply(names(inserts), function(x) {
  write.table(inserts[[x]], paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Insert/",
                        bislr_dates %>% 
                          filter(DECRYPT == x) %>%
                          select(INSERT) %>%
                          pull()),
              sep = "~", row.names = FALSE)
})

# save updated mshq dates file
write_xlsx(bislr_dates, paste0(universal_dir, "Mapping/BISLR_File_Dates.xlsx"))

# list new insert files if there are any
if (length(new_inserts) > 0) {
  cat(cat(paste0(new_inserts, "\n")), "has been added to the Insert folder", fill = TRUE)
} else {
  print("Insert files are already up to date")
}

# list files that need START_DATE and END_DATE values
if (nrow(bislr_dates_new) > 0) {
  kable(bislr_dates_new, 
        caption = "The following files need START_DATE and END_DATE values in BISLR_File_Dates.xlsx:") %>% 
    kable_styling(latex_options = "striped", 
                  font_size = 10) %>%
    row_spec(0, font_size = 13)
} else {
  print("BISLR_File_Dates.xlsx is up to date")
}

print("bislr_insert successful")
```

# Quality Check
#### Job Code Check
```{r jobcode check, echo=FALSE}
# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# establish connection to OAO oracle cloud db
con <- dbConnect(odbc(), "OracleODBC-21_5",
                 uid = "lenang01",
                 pwd = "A9xXY#fztK")

# get set of unique files in MSHQ database
mshq_db_files <- tbl(con, "DATA_MSHQ_ORACLE") %>%
  select(FILE_NAME) %>%
  distinct() %>%
  collect() %>%
  pull

# get set of unique files in BISLR database
bislr_db_files <- tbl(con, "DATA_BISLR_ORACLE") %>%
  select(FILE_NAME) %>%
  distinct() %>%
  collect() %>%
  pull()

# get new files in network drive
mshq_inserts <- list.files(paste0(universal_dir, "/Labor/Raw Data/MSHQ_sftp_sync/Insert/"))
bislr_inserts <- list.files(paste0(universal_dir, "/Labor/Raw Data/BISLR_sftp_sync/Insert/"))

# get set of files to check the mapping files with
mshq_new <- setdiff(mshq_inserts, mshq_db_files)
bislr_new <- setdiff(bislr_inserts, bislr_db_files)

# get all jobcodes in mapping file within database
jobcodes <- tbl(con, "MAPPING_JOBCODE") %>%
  select(JOBCODE, PAYROLL) %>%
  collect()

# read all insert files that need jobcode check and bind them
mshq_check <- lapply(mshq_new, function(x) {
  data <- read.csv(paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Insert/", x),
                    sep = "~", header = T, stringsAsFactors = F,
                    colClasses = rep("character", 33), strip.white = TRUE)
})
mshq_check <- do.call("rbind", mshq_check)

bislr_check <- lapply(bislr_new, function(x) {
  data <- read.csv(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Insert/", x),
                    sep = "~", header = T, stringsAsFactors = F,
                    colClasses = rep("character", 33), strip.white = TRUE)
})
bislr_check <- do.call("rbind", bislr_check)

# check jobcodes in new insert files with jobcode mapping file
if (length(setdiff((mshq_check %>% 
                    select(JOBCODE) %>% pull()),
                   (jobcodes %>% 
                    filter(PAYROLL == 'MSHQ') %>% select(JOBCODE) %>% pull())))
    == 0) {
  print("MSHQ Jobcodes are up to date in MAPPING_JOBCODE")
} else {
  # create data frame for new jobcodes at MSHQ
  new_mshq_jobcodes <- mshq_check %>%
    filter(!(JOBCODE %in% (jobcodes %>% 
                             filter(PAYROLL == 'MSHQ') %>% 
                             select(JOBCODE) %>% pull))) %>%
    mutate(PAYROLL = "MSHQ") %>%
    select(JOBCODE, PAYROLL, POSITION_CODE_DESCRIPTION) %>%
    distinct()
  
  # save df with new MSHQ jobcodes
  write_xlsx(new_mshq_jobcodes, paste0(universal_dir, 
                                       "Mapping/sftp_sync_decrypt_insert/JobCode/MSHQ/new_mshq_jobcodes_", 
                                       Sys.Date(), ".xlsx"))
  
  # print kable of new MSHQ jobcodes
  kable(new_mshq_jobcodes, 
        caption = "The following MSHQ jobcodes need to be added to MAPING_JOBCODE:") %>% 
    kable_styling(latex_options = "striped", 
                  font_size = 10) %>%
    row_spec(0, font_size = 13)
}

if (length(setdiff((mshq_check %>% 
                    select(JOBCODE) %>% pull()),
                   (jobcodes %>% 
                    filter(PAYROLL == 'MSHQ') %>% select(JOBCODE) %>% pull())))
    == 0) {
  print("BISLR Jobcodes are up to date in MAPPING_JOBCODE")
} else {
  # create data frame for new jobcodes at BISLR
  new_bislr_jobcodes <- bislr_check %>%
    filter(!(JOBCODE %in% (jobcodes %>% 
                             filter(PAYROLL == 'BISLR') %>% 
                             select(JOBCODE) %>% pull))) %>%
    mutate(PAYROLL = "BISLR") %>%
    select(JOBCODE, PAYROLL, POSITION_CODE_DESCRIPTION) %>%
    distinct()
  
  # save df with new BISLR jobcodes
  write_xlsx(new_bislr_jobcodes, paste0(universal_dir, 
                                       "Mapping/sftp_sync_decrypt_insert/JobCode/BISLR/new_bislr_jobcodes_", 
                                       Sys.Date(), ".xlsx"))
  
  # print kable of new MSHQ jobcodes
  kable(new_bislr_jobcodes, 
        caption = "The following BISLR jobcodes need to be added to MAPING_JOBCODE:") %>% 
    kable_styling(latex_options = "striped", 
                  font_size = 10) %>%
    row_spec(0, font_size = 13)
}

print("Jobcode check successful")
```

#### Pay Code Check
```{r paycode check , echo=FALSE}

# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# establish connection to OAO oracle cloud db
con <- dbConnect(odbc(), "OracleODBC-21_5",
                 uid = "lenang01",
                 pwd = "A9xXY#fztK")

# Unique MSHQ files in database
mshq_db_files <- tbl(con, "DATA_MSHQ_ORACLE")%>%
  select(FILE_NAME) %>%
  distinct() %>%
  collect() %>%
  pull()
  
# Unique BISLR files in database
bislr_db_files <- tbl(con, "DATA_BISLR_ORACLE")%>%
  select(FILE_NAME) %>%
  distinct() %>%
  collect() %>%
  pull()

# get list of files in insert folder currently
mshq_insert_files <- list.files(paste0(universal_dir, "/Labor/Raw Data/MSHQ_sftp_sync/Insert/"))
bislr_insert_files <- list.files(paste0(universal_dir, "/Labor//Raw Data/BISLR_sftp_sync/Insert/"))

# Get new files
mshq_new <- setdiff(mshq_insert_files, mshq_db_files)
bislr_new <- setdiff(bislr_insert_files, bislr_db_files)

# Read mapping pay code
mapping_paycode <- tbl(con, "MAPPING_PAYCODE") %>%
                   select(PAYCODE_RAW) %>%
                   distinct() %>%
                   collect() %>%
                   pull()

# read in new insert files and bind them all
mshq_paycodes <- lapply(mshq_new, function(x){
  data <- read.csv(paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Insert/", x), sep = "~", header = T,
                   stringsAsFactors = F,
                   colClasses = rep("character", 33),
                   strip.white = TRUE) 
 })
mshq_paycodes <- do.call("rbind", mshq_paycodes)

bislr_paycodes <- lapply(bislr_new , function(x){
  data <- read.csv(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Insert/", x), sep = "~", header = T,
                   stringsAsFactors = F,
                   colClasses = rep("character", 33),
                   strip.white = TRUE) 
 })
bislr_paycodes <- do.call("rbind", bislr_paycodes)

new_paycodes <- rbind(mshq_paycodes, bislr_paycodes)

# get new paycodes in all new insert files
new_paycodes <- new_paycodes %>%
         select(FILE_NAME, PAYCODE) %>%
    filter(!(PAYCODE %in% mapping_paycode)) %>%
    distinct()

if (nrow(new_paycodes) == 0 ) {
  print("MSHS Paycodes are up to date in MAPPING_PAYCODE")
} else {
  # save new paycodes df
  write_xlsx(new_paycodes, paste0(universal_dir, 
                                  "Mapping/sftp_sync_decrypt_insert/PayCode/new_paycodes_", 
                                       Sys.Date(), ".xlsx"))
  # print new paycodes df
  kable(new_paycodes, 
        caption = "The following MSHS paycodes need to be added to MAPING_PAYCODE:") %>% 
    kable_styling(latex_options = "striped", 
                  font_size = 10) %>%
    row_spec(0, font_size = 13)
}

print("Paycode check successful")
```

#### Pay Cycle Check
```{r paycycle check , echo=FALSE}

library(odbc)
# set universal data directory
universal_dir <- "/SharedDrive/deans/Presidents/SixSigma/MSHS Productivity/Productivity/Universal Data/"

# establish connection to OAO oracle cloud db
con <- dbConnect(odbc(), "OracleODBC-21_5",
                 uid = "lenang01",
                 pwd = "A9xXY#fztK")

# Unique MSHQ files in database
mshq_db_files <- tbl(con, "DATA_MSHQ_ORACLE")%>%
  select(FILE_NAME) %>%
  distinct() %>%
  collect() %>%
  pull()
  
# Unique BISLR files in database
bislr_db_files <- tbl(con, "DATA_BISLR_ORACLE")%>%
  select(FILE_NAME) %>%
  distinct() %>%
  collect() %>%
  pull()

# get list of files in insert folder currently
mshq_insert_files <- list.files(paste0(universal_dir, "/Labor/Raw Data/MSHQ_sftp_sync/Insert/"))
bislr_insert_files <- list.files(paste0(universal_dir, "/Labor//Raw Data/BISLR_sftp_sync/Insert/"))

# Get new files
mshq_new <- setdiff(mshq_insert_files, mshq_db_files)
bislr_new <- setdiff(bislr_insert_files, bislr_db_files)

# Read mapping paycycle
unique_dates <- tbl(con,  "MAPPING_PAYCYCLE") %>%
                    collect() %>%
                    select(PAYCYCLE_DATE) %>%
                    mutate(PAYCYCLE_DATE = as.Date(PAYCYCLE_DATE)) %>%
                    distinct() %>%
                    pull()

# read new insert files for MSHS and bind them all
mshq_paycycles <- lapply(mshq_new, function(x){
  data <- read.csv(paste0(universal_dir, "Labor/Raw Data/MSHQ_sftp_sync/Insert/", x), sep = "~", header = T,
                   stringsAsFactors = F,
                   colClasses = rep("character", 33),
                   strip.white = TRUE)
})
mshq_paycycles <- do.call("rbind", mshq_paycycles)

bislr_paycycles <- lapply(bislr_new , function(x){
  data <- read.csv(paste0(universal_dir, "Labor/Raw Data/BISLR_sftp_sync/Insert/", x), sep = "~", header = T,
                   stringsAsFactors = F,
                   colClasses = rep("character", 33),
                   strip.white = TRUE) 
})
bislr_paycycles  <- do.call("rbind", bislr_paycycles)

new_paycycles <- rbind(mshq_paycycles, bislr_paycycles)

# get df of all new paycycles
new_paycycles <- new_paycycles %>%
   mutate(END_DATE= as.Date(END_DATE)) %>%
         select(FILE_NAME, END_DATE) %>%
    filter(!(END_DATE %in% unique_dates)) %>%
    distinct()

if (nrow(new_paycycles) == 0 ) {
  print("MSHS End Dates are included in MAPPING_PAYCYCLE")
} else {
  # save df of new paycycles
  write_xlsx(new_paycycles, paste0(universal_dir, 
                                  "Mapping/sftp_sync_decrypt_insert/PayCycle/new_paycycles_", 
                                       Sys.Date(), ".xlsx"))
  # print new paycycles
  kable(new_paycycles, 
        caption = "The following MSHS End Dates are not included in MAPING_PAYCYCLES:") %>% 
    kable_styling(latex_options = "striped", 
                  font_size = 10) %>%
    row_spec(0, font_size = 13)
}

print("Paycycle check successful")
```